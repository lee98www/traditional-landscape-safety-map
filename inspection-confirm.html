<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>안전 점검 실시 - 확인하기 | 전통조경 안전지도 시범서비스</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/photo-gallery.css">

  <!-- Data Loading Modules -->
  <script src="js/data-loader.js"></script>
  <script src="js/photo-gallery.js"></script>
  <!-- html2canvas for PNG export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* 확인 페이지 - 디자인 시안 기준 */
    .confirm-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #EBF3FF;
    }

    /* Header - 디자인 시안 기준 */
    .header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: #FFFFFF;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
    }

    .header__logo {
      display: inline-flex;
      align-items: center;
      padding: 8px 20px;
      background-color: #E8F4FD;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      color: #333333;
      text-decoration: none;
    }

    .header__title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      font-weight: 600;
      color: #333333;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px 120px;
    }

    /* Report Preview - 디자인 시안: 파란색 테두리(좌측/상단 강조) */
    .report-preview {
      width: 100%;
      max-width: 960px;
      background-color: #FFFFFF;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      border: 2px solid #4A90E2;
      border-left-width: 4px;
      border-top-width: 4px;
      font-family: 'KoPub Dotum', 'Noto Sans KR', sans-serif;
    }

    .report-header {
      background-color: #0052CC;
      color: #FFFFFF;
      padding: 24px;
      text-align: center;
    }

    .report-header__title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .report-header__subtitle {
      font-size: 14px;
      opacity: 0.9;
    }

    .report-body {
      padding: 32px;
    }

    .report-section {
      margin-bottom: 24px;
    }

    .report-section:last-child {
      margin-bottom: 0;
    }

    .report-section__title {
      font-size: 14px;
      font-weight: 600;
      color: #0052CC;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #E0E0E0;
    }

    .report-section__subtitle {
      font-size: 14px;
      font-weight: 600;
      color: #333333;
      margin: 24px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #E0E0E0;
    }

    .report-info {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 8px 16px;
    }

    .report-info__label {
      font-size: 13px;
      color: #666666;
    }

    .report-info__value {
      font-size: 13px;
      color: #333333;
      font-weight: 500;
    }

    .report-summary {
      background-color: #F5F5F5;
      border-radius: 8px;
      padding: 16px;
    }

    .report-summary__item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .report-summary__item:last-child {
      margin-bottom: 0;
    }

    .report-summary__label {
      font-size: 13px;
      color: #666666;
    }

    .report-summary__value {
      font-size: 13px;
      color: #333333;
      font-weight: 600;
    }

    .report-summary__value--warning {
      color: #FFC107;
    }

    .report-summary__value--danger {
      color: #DC3545;
    }

    /* Buttons - 디자인 시안 기준 */
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
    }

    .btn-action {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 160px;
      height: 48px;
      padding: 0 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-submit {
      background-color: #0052CC;
      color: #FFFFFF;
      border: none;
    }

    .btn-submit:hover {
      background-color: #003D99;
    }

    .btn-download {
      background-color: #FFFFFF;
      color: #0052CC;
      border: 2px solid #0052CC;
    }

    .btn-download:hover {
      background-color: #E8F4FD;
    }

    /* Navigation Buttons - 디자인 시안 기준 */
    .nav-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 16px 24px;
      background-color: #EBF3FF;
      z-index: 100;
    }

    .btn-nav {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-prev {
      background-color: #FFFFFF;
      color: #0052CC;
      border: 2px solid #0052CC;
    }

    .btn-prev:hover {
      background-color: #E8F4FD;
    }

    .btn-nav svg {
      width: 18px;
      height: 18px;
    }

    /* Modal - 디자인 시안 기준 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 99999;
    }

    .modal-overlay.active {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .modal {
      display: block !important;
      position: relative;
      background-color: #FFFFFF;
      border-radius: 16px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);
      z-index: 100000;
      opacity: 1 !important;
      visibility: visible !important;
    }

    .modal__icon {
      width: 64px;
      height: 64px;
      background-color: #4CAF50;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .modal__icon svg {
      width: 32px;
      height: 32px;
      color: #FFFFFF;
    }

    .modal__title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #333333;
      margin-bottom: 16px;
    }

    .modal__message {
      font-size: 14px;
      color: #666666;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal__message-box {
      background-color: #F5F5F5;
      padding: 16px 20px;
      border-radius: 8px;
      font-size: 14px;
      color: #333333;
      margin-bottom: 24px;
    }

    .modal__buttons {
      display: flex;
      gap: 12px;
    }

    .btn-modal {
      flex: 1;
      height: 48px;
      padding: 0 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-modal--primary {
      background-color: #0052CC;
      color: #FFFFFF;
      border: none;
    }

    .btn-modal--primary:hover {
      background-color: #003D99;
    }

    .btn-modal--outline {
      background-color: #FFFFFF;
      color: #0052CC;
      border: 2px solid #0052CC;
    }

    .btn-modal--outline:hover {
      background-color: #E8F4FD;
    }

    .btn-modal--secondary {
      background-color: #FFFFFF;
      color: #333333;
      border: 1px solid #D0D0D0;
    }

    .btn-modal--secondary:hover {
      background-color: #F5F5F5;
    }

    /* Footer - 디자인 시안 기준 */
    .footer {
      background-color: #1A1A1A;
      color: #FFFFFF;
      padding: 24px 40px;
    }

    .footer__content {
      max-width: 1400px;
      margin: 0 auto;
    }

    .footer__links {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 12px;
    }

    .footer__link {
      color: #CCCCCC;
      text-decoration: none;
    }

    .footer__separator {
      color: #666666;
    }

    .footer__info {
      display: flex;
      gap: 16px;
      margin-bottom: 8px;
    }

    .footer__info-item {
      color: #999999;
      font-size: 11px;
    }

    .footer__copyright {
      color: #666666;
      font-size: 11px;
    }

    /* 점검표 테이블 - 디자인 시안 기준 */
    .checklist-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      border: 1px solid #333;
      table-layout: fixed;
    }

    .checklist-table th,
    .checklist-table td {
      border: 1px solid #D0D0D0;
      padding: 10px 8px;
      text-align: center;
      vertical-align: middle;
      word-break: keep-all;
    }

    .checklist-table th {
      background-color: #F5F5F5;
      font-weight: 600;
      color: #333;
    }

    .checklist-table .row-header {
      background-color: #FAFAFA;
      font-weight: 500;
      text-align: center;
      width: 50px;
    }

    .checklist-table .sub-header {
      background-color: #F0F0F0;
      font-weight: 600;
      width: 50px;
    }

    .checklist-table .col-item {
      width: 70px;
    }

    .checklist-table .col-rating {
      width: 100px;
    }

    .checklist-table .col-note {
      width: 80px;
    }

    /* 체크박스 스타일 */
    .check-cell {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .check-box {
      width: 14px;
      height: 14px;
      border: 2px solid #999;
      border-radius: 2px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background-color: #FFFFFF;
    }

    .check-box.checked {
      background-color: #0052CC;
      border-color: #0052CC;
    }

    .check-box.checked::after {
      content: '';
      width: 4px;
      height: 8px;
      border: solid #FFFFFF;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      margin-bottom: 2px;
    }

    .check-label {
      font-size: 11px;
      color: #333;
    }

    /* 일반 현황 테이블 */
    .status-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      border: 1px solid #333;
      margin-bottom: 16px;
    }

    .status-table th,
    .status-table td {
      border: 1px solid #D0D0D0;
      padding: 10px 12px;
      vertical-align: middle;
    }

    .status-table th {
      background-color: #F5F5F5;
      font-weight: 600;
      text-align: center;
      width: 120px;
    }

    .status-table td {
      text-align: left;
    }

    .status-table .option-group {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .status-table .option-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* Report Judgment */
    .report-judgment {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .report-judgment__item {
      flex: 1;
      min-width: 100px;
      padding: 12px 8px;
      text-align: center;
      border: 2px solid #E0E0E0;
      border-radius: 8px;
      background-color: #FFFFFF;
    }

    .report-judgment__item--selected {
      border-color: #0052CC;
      background-color: #E8F4FD;
    }

    .report-judgment__item--selected .report-judgment__label {
      color: #0052CC;
    }

    .report-judgment__label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333333;
      margin-bottom: 2px;
    }

    .report-judgment__desc {
      font-size: 11px;
      color: #999999;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .report-info {
        grid-template-columns: 100px 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn-action {
        width: 100%;
      }

      .checklist-table {
        font-size: 10px;
      }

      .checklist-table th,
      .checklist-table td {
        padding: 6px 4px;
      }

      .report-judgment {
        flex-direction: column;
      }

      .report-judgment__item {
        min-width: auto;
      }
    }
  </style>
</head>
<body class="confirm-page">
  <!-- Header -->
  <header class="header">
    <a href="index.html" class="header__logo">전통조경 안전지도 시범서비스</a>
    <h1 class="header__title" id="headerTitle">안전 점검 실시</h1>
    <div style="width: 180px;"></div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="report-preview">
      <div class="report-header">
        <h2 class="report-header__title" id="reportTitle">안전 점검 보고서</h2>
        <p class="report-header__subtitle">전통조경 안전지도 시범서비스</p>
      </div>

      <div class="report-body">
        <!-- 점검 기본 정보 (Phase 5 추가) -->
        <div class="report-section">
          <h3 class="report-section__title">점검 기본 정보</h3>
          <div class="report-info">
            <div class="report-info__label">점검 유형</div>
            <div class="report-info__value" id="inspectionTypeDisplay">-</div>

            <div class="report-info__label">대상지</div>
            <div class="report-info__value" id="siteDisplay">-</div>

            <div class="report-info__label">점검 대상</div>
            <div class="report-info__value" id="targetDisplay">-</div>

            <div class="report-info__label">점검 일자</div>
            <div class="report-info__value" id="dateDisplay">-</div>

            <div class="report-info__label">점검자</div>
            <div class="report-info__value" data-field="inspector">-</div>
          </div>
        </div>

        <!-- 일반 현황 - 점검 대상별 동적 렌더링 -->
        <div class="report-section" id="generalInfoSection">
          <h3 class="report-section__title">일반 현황</h3>
          <div id="generalInfoContainer">
            <!-- JS로 target에 따라 동적 렌더링 -->
          </div>
        </div>

        <!-- 점검 항목 - 점검 대상별 동적 렌더링 -->
        <div class="report-section" id="checklistSection">
          <h3 class="report-section__title">점검 항목</h3>
          <div id="checklistContainer">
            <!-- JS로 target에 따라 동적 렌더링 -->
          </div>
        </div>

        <!-- 예상 피해 유형 - 점검 대상별 동적 렌더링 -->
        <div class="report-section" id="damageTypeSection">
          <h3 class="report-section__title">예상 피해 유형 (중복가능)</h3>
          <div class="option-group damage-type-options" id="damageTypeContainer" style="padding: 12px 0;">
            <!-- JS로 target에 따라 동적 렌더링 -->
          </div>
        </div>

        <!-- 종합 판정 -->
        <div class="report-section">
          <h3 class="report-section__title">종합 판정</h3>
          <div class="report-info" style="margin-bottom: 16px;">
            <div class="report-info__label">판정 등급</div>
            <div class="report-info__value" data-field="rating" style="font-weight: 700; font-size: 16px;">-</div>

            <div class="report-info__label">점검자 의견</div>
            <div class="report-info__value" data-field="inspectorOpinion" style="grid-column: 2; white-space: pre-wrap;">(의견 없음)</div>
          </div>
          <h4 class="report-section__subtitle">점검 결과에 따른 보수 필요성</h4>
          <div class="report-judgment">
            <div class="report-judgment__item" data-rating="안전">
              <span class="report-judgment__label">안전</span>
              <span class="report-judgment__desc">(현상유지)</span>
            </div>
            <div class="report-judgment__item" data-rating="관심">
              <span class="report-judgment__label">관심</span>
              <span class="report-judgment__desc">(모니터링)</span>
            </div>
            <div class="report-judgment__item" data-rating="주의">
              <span class="report-judgment__label">주의</span>
              <span class="report-judgment__desc">(경미보수)</span>
            </div>
            <div class="report-judgment__item" data-rating="경계">
              <span class="report-judgment__label">경계</span>
              <span class="report-judgment__desc">(수리)</span>
            </div>
            <div class="report-judgment__item" data-rating="위험">
              <span class="report-judgment__label">위험</span>
              <span class="report-judgment__desc">(즉시 조치)</span>
            </div>
          </div>
        </div>

        <!-- 사진 기록 (Phase 5 추가) -->
        <div class="report-section" id="photoSection" style="display: none;">
          <h3 class="report-section__title">사진 기록</h3>
          <div id="photoContainer" class="photo-container" style="display: flex; flex-wrap: wrap; gap: 12px;"></div>
        </div>

        <!-- 제출 버튼 (디자인 시안 기준: 제출하기만 표시) -->
        <div class="action-buttons">
          <button type="button" class="btn-action btn-submit" onclick="submitReport()">
            제출하기
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20,6 9,17 4,12"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Navigation Buttons -->
  <div class="nav-buttons">
    <button type="button" class="btn-nav btn-prev" onclick="goBack()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5"/>
        <path d="M12 19l-7-7 7-7"/>
      </svg>
      이전
    </button>
    <div></div>
  </div>

  <!-- 제출 완료 모달 (디자인 시안 02_07_02 기준) -->
  <div class="modal-overlay" id="submitModal">
    <div class="modal">
      <h3 class="modal__title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0052CC" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="12" x2="12" y2="8"/>
          <circle cx="12" cy="16" r="0.5" fill="#0052CC"/>
        </svg>
        알림
      </h3>
      <div class="modal__message-box">제출 완료되었습니다.</div>
      <div class="modal__buttons">
        <button type="button" class="btn-modal btn-modal--outline" onclick="downloadReport()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="7,10 12,15 17,10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          보고서 다운로드
        </button>
        <button type="button" class="btn-modal btn-modal--primary" onclick="goHome()">
          종료
        </button>
      </div>
    </div>
  </div>

  <!-- 다운로드 완료 모달 -->
  <div class="modal-overlay" id="downloadModal">
    <div class="modal">
      <div class="modal__icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
          <polyline points="20,6 9,17 4,12"/>
        </svg>
      </div>
      <h3 class="modal__title">다운로드 완료</h3>
      <p class="modal__message">보고서 다운로드가 완료되었습니다.</p>
      <div class="modal__buttons">
        <button type="button" class="btn-modal btn-modal--primary" onclick="closeDownloadModal()">
          확인
        </button>
      </div>
    </div>
  </div>

  <script>
    // URL 파라미터
    const urlParams = new URLSearchParams(window.location.search);
    const inspectionId = urlParams.get('id'); // 새로운 방식: inspection ID
    const siteId = urlParams.get('site') || '3';
    const inspectionType = urlParams.get('type') || 'regular';
    const targetRaw = urlParams.get('target');
    const target = targetRaw || '석축 및 옹벽';

    // 디버그: target 파라미터 확인
    console.log('[inspection-confirm] URL search:', window.location.search);
    console.log('[inspection-confirm] target raw:', targetRaw);
    console.log('[inspection-confirm] target:', target);

    // 헤더에 점검 대상 항목명 표시
    document.getElementById('headerTitle').textContent = `안전 점검 실시 (${target})`;

    // 보고서 타이틀에도 항목명 표시
    document.getElementById('reportTitle').textContent = `안전 점검 보고서 (${target})`;

    // sessionStorage에서 점검 데이터 불러오기
    let inspectionData = JSON.parse(sessionStorage.getItem('inspectionData') || '{}');

    // 전역 변수로 현재 점검표 저장
    window.currentInspection = null;

    // 사이트 정보 (설계서 기준: 낙선재, 주합루, 의두합)
    const sites = {
      1: '창덕궁 낙선재 권역',
      2: '창덕궁 주합루 권역',
      3: '창덕궁 의두합 권역'
    };

    // 화면 초기화 (ID가 존재하는 경우에만 업데이트)
    const inspectionTypeEl = document.getElementById('inspectionTypeDisplay');
    const siteEl = document.getElementById('siteDisplay');
    const targetEl = document.getElementById('targetDisplay');
    const dateEl = document.getElementById('dateDisplay');

    // sessionStorage 데이터가 있으면 우선 사용, 없으면 URL 파라미터 사용
    if (inspectionTypeEl) inspectionTypeEl.textContent = inspectionData.inspectionTypeName || (inspectionType === 'regular' ? '정기점검' : '상시점검');
    if (siteEl) siteEl.textContent = (inspectionData.basicInfo && inspectionData.basicInfo['국가유산명']) || sites[siteId] || '창덕궁 낙선재 권역';
    if (targetEl) targetEl.textContent = inspectionData.target || target;
    if (dateEl) dateEl.textContent = inspectionData.inspectionDate || new Date().toLocaleDateString('ko-KR').replace(/\./g, '.').slice(0, -1);

    // 일반현황 정보 업데이트
    function updateBasicInfo() {
      if (inspectionData.basicInfo) {
        // 국가유산유형
        const typeEl = document.querySelector('.report-info__value');
        if (typeEl && inspectionData.basicInfo['국가유산유형']) {
          typeEl.textContent = inspectionData.basicInfo['국가유산유형'];
        }

        // 소재지
        const addressEl = document.querySelectorAll('.report-info__value')[1];
        if (addressEl && inspectionData.basicInfo['소재지']) {
          addressEl.textContent = inspectionData.basicInfo['소재지'];
        }

        // 소유자/관리자
        const ownerEl = document.querySelectorAll('.report-info__value')[2];
        if (ownerEl && inspectionData.basicInfo['소유자관리자']) {
          ownerEl.textContent = inspectionData.basicInfo['소유자관리자'];
        }

        // 관리 항목 체크박스 업데이트
        if (inspectionData.basicInfo['관리항목']) {
          const items = inspectionData.basicInfo['관리항목'];
          const checkItems = document.querySelectorAll('.management-item');
          checkItems.forEach(item => {
            const label = item.querySelector('.check-label')?.textContent;
            const checkbox = item.querySelector('.check-box');
            if (checkbox && label) {
              if (items[label]) {
                checkbox.classList.add('checked');
              } else {
                checkbox.classList.remove('checked');
              }
            }
          });
        }
      }
    }

    // 점검결과 업데이트
    function updateResultInfo() {
      if (inspectionData.result && inspectionData.result.rating) {
        const rating = inspectionData.result.rating;
        const judgmentItems = document.querySelectorAll('.report-judgment__item');

        judgmentItems.forEach(item => {
          const itemRating = item.getAttribute('data-rating');
          if (itemRating === rating) {
            item.classList.add('report-judgment__item--selected');
          } else {
            item.classList.remove('report-judgment__item--selected');
          }
        });
      }
    }

    // 종합판정 업데이트
    function updateFinalInfo() {
      if (inspectionData.final) {
        // 예상 피해 유형
        if (inspectionData.final.damageTypes && inspectionData.final.damageTypes.length > 0) {
          const damageItems = document.querySelectorAll('.damage-type-options .option-item');
          damageItems.forEach(item => {
            const damageType = item.getAttribute('data-type');
            const checkbox = item.querySelector('.check-box');
            if (checkbox && damageType) {
              if (inspectionData.final.damageTypes.includes(damageType)) {
                checkbox.classList.add('checked');
              } else {
                checkbox.classList.remove('checked');
              }
            }
          });
        }

        // 조사자 의견
        const opinionEl = document.querySelector('[data-field="inspectorOpinion"]');
        if (opinionEl) {
          if (inspectionData.final.opinion && inspectionData.final.opinion.trim()) {
            opinionEl.textContent = inspectionData.final.opinion;
          } else {
            opinionEl.textContent = '(의견 없음)';
          }
        }
      }

      // 점검결과의 rating도 종합판정 영역에 표시
      if (inspectionData.result && inspectionData.result.rating) {
        const ratingEl = document.querySelector('[data-field="rating"]');
        if (ratingEl) {
          ratingEl.textContent = inspectionData.result.rating;
          // 등급별 색상
          const colors = {
            '안전': '#4CAF50',
            '관심': '#8BC34A',
            '주의': '#FFC107',
            '경계': '#FF9800',
            '위험': '#F44336'
          };
          ratingEl.style.color = colors[inspectionData.result.rating] || '#333';
        }
      }
    }

    // 점검항목 체크리스트 업데이트 (sessionStorage 데이터 기반)
    function updateChecklistDisplay() {
      if (!inspectionData.checklist) {
        console.log('No checklist data in sessionStorage');
        return;
      }

      console.log('Updating checklist display with:', inspectionData.checklist);

      // 먼저 모든 체크박스 초기화 (하드코딩된 checked 제거)
      document.querySelectorAll('.checklist-table .check-box').forEach(box => {
        box.classList.remove('checked');
      });

      // 일반현황 체크박스도 초기화
      document.querySelectorAll('.status-table .check-box').forEach(box => {
        box.classList.remove('checked');
      });

      // facility 점검 항목 처리
      if (inspectionData.checklist.facility) {
        inspectionData.checklist.facility.forEach(item => {
          if (item.item && item.rating) {
            updateCheckboxInTable(item.item, item.rating);
          }
        });
      }

      // additional 점검 항목 처리
      if (inspectionData.checklist.additional) {
        inspectionData.checklist.additional.forEach(item => {
          if (item.item && item.rating) {
            updateCheckboxInTable(item.item, item.rating);
          }
        });
      }
    }

    // 테이블 내 체크박스 상태 업데이트
    function updateCheckboxInTable(itemName, selectedValue) {
      console.log('Updating checkbox:', itemName, '->', selectedValue);

      // 점검표 테이블에서 해당 항목 행 찾기
      const rows = document.querySelectorAll('.checklist-table tbody tr');

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');

        // 각 셀을 순회하며 항목명 찾기
        for (let i = 0; i < cells.length; i++) {
          const cell = cells[i];
          const cellText = cell.textContent.trim();

          // 항목명이 일치하는지 확인 (rowspan/colspan이 없는 일반 텍스트 셀)
          if (cellText === itemName || cellText.includes(itemName)) {
            // 이 행의 모든 체크박스에서 선택값 찾기
            const checkCells = row.querySelectorAll('.check-cell');

            checkCells.forEach(checkCell => {
              const labelText = checkCell.textContent.trim();
              const checkBox = checkCell.querySelector('.check-box');

              if (checkBox) {
                // 선택된 값과 라벨이 일치하면 체크
                if (labelText.includes(selectedValue) || selectedValue.includes(labelText.replace(/\s+/g, ''))) {
                  checkBox.classList.add('checked');
                  console.log('Checked:', itemName, labelText);
                }
              }
            });

            break; // 항목을 찾았으면 루프 종료
          }
        }
      });
    }

    // 페이지 로드 시 데이터 업데이트
    updateBasicInfo();
    updateResultInfo();
    updateFinalInfo();
    updateChecklistDisplay();

    // ============================================================
    // 점검 대상별 동적 렌더링 함수들
    // ============================================================

    // 점검 대상별 일반현황 정의
    const generalInfoByTarget = {
      '비탈면': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '재료', type: 'checkbox', options: ['흙', '암반', '혼합'], key: 'material' },
          { name: '경계', type: 'checkbox', options: ['시설물(석축 및 담장 등)', '없음(토사 등)'], key: 'boundary' }
        ]
      },
      '석축 및 옹벽': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '제원', type: 'dimension', keys: ['length', 'height'] },
          { name: '재료', type: 'checkbox', options: ['석재', '콘크리트', '기타'], key: 'material' }
        ]
      },
      '지반': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '재료', type: 'checkbox', options: ['흙', '석재', '소성재', '아스콘·콘크리트', '혼합'], key: 'material' }
        ]
      },
      '다리': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '유형', type: 'text', key: 'type' },
          { name: '제원', type: 'dimension', keys: ['length', 'height'] },
          { name: '재료', type: 'checkbox', options: ['목재', '석재', '소성재', '흙', '강재', '콘크리트', '복합재', '기타'], key: 'material' }
        ]
      },
      '지당': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '제원', type: 'text', key: 'dimension' },
          { name: '재료', type: 'checkbox', options: ['흙', '수지재', '강재', '석재', '콘크리트', '기타'], key: 'material' },
          { name: '수질 상태', type: 'checkbox', options: ['녹조', '부유물', '기타'], key: 'waterQuality' }
        ]
      },
      '문': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '유형', type: 'text', key: 'type' },
          { name: '재료', type: 'checkbox', options: ['목재', '석재', '소성재', '흙', '강재', '콘크리트', '기타'], key: 'material' }
        ]
      },
      '담장': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '제원', type: 'dimension', keys: ['length', 'height'] },
          { name: '재료', type: 'checkbox', options: ['목재', '석재', '소성재', '흙', '강재', '콘크리트', '기타'], key: 'material' }
        ]
      },
      '굴뚝': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '재료', type: 'checkbox', options: ['목재', '석재', '소성재', '흙', '강재', '콘크리트', '기타'], key: 'material' }
        ]
      },
      '배수시설': {
        fields: [
          { name: '종류', type: 'checkbox', options: ['수로', '집수정', '명거', '암거'], key: 'facilityType' },
          { name: '재료', type: 'checkbox', options: ['흙', '수지재', '강재', '석재', '콘크리트', '기타'], key: 'material' },
          { name: '지형', type: 'checkbox', options: ['평지', '경사지', '석축, 옹벽'], key: 'terrain' }
        ]
      },
      '단일목': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '형상', type: 'tree', keys: ['species', 'height', 'dbh', 'crownWidth'] }
        ]
      },
      '군락': {
        fields: [
          { name: '위치', type: 'text', key: 'location' },
          { name: '제원', type: 'tree2', keys: ['species', 'height'] },
          { name: '종류', type: 'checkbox', options: ['관목', '교목', '상록수', '낙엽수', '활엽수', '침엽수'], key: 'treeType' },
          { name: '활력도', type: 'checkbox', options: ['높음', '보통', '낮음'], key: 'vitality' }
        ]
      }
    };

    // 점검 대상별 점검항목 정의
    const checklistItemsByTarget = {
      '비탈면': {
        facility: [
          { name: '높이', ratings: ['<5m', '5~11m', '11~18m', '18~25m', '>25m'] },
          { name: '경사', ratings: ['<15°', '15-20°', '20~25°', '25-30°', '30° 이상'] },
          { name: '토사·암반층 결합력', ratings: ['매우 견고', '조밀/견고', '양호/중간', '느슨/연약', '매우 느슨'] },
          { name: '토층심도', ratings: ['0~20㎝', '20~40㎝', '40~60㎝', '60~80㎝', '80㎝ 이상'] },
          { name: '피복율', ratings: ['50% 이상', '-', '50% 이하', '-', '없음'] },
          { name: '낙석흔적', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '풍화도', ratings: ['신선(해당없음)', '약간풍화', '보통풍화', '심한풍화', '완전풍화'] },
          { name: '지면유출흔적', ratings: ['없음', '-', '습윤', '-', '젖음, 용수'] },
          { name: '배수상태', ratings: ['원활', '-', '습윤', '-', '물고임'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '수목', '보행로', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 9,
        additionalCount: 4
      },
      '석축 및 옹벽': {
        facility: [
          { name: '세굴', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '침하', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '우수침투흔', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '균열', section: '전면부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '전면부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '전면부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '누수흔', section: '전면부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '채움재 유실', section: '전면부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '줄눈 유실', section: '전면부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '변형', section: '전면부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '배수공', section: '상단부', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] },
          { name: '낙석 흔적', section: '상단부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '지반 침하', section: '상단부', ratings: ['없음', '-', '-', '-', '있음'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '수목', '보행로', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 13,
        additionalCount: 4
      },
      '지반': {
        facility: [
          { name: '세굴', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '침하', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '공동', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '지반노출', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '지면유출흔적', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '지면구배', ratings: ['있음', '-', '-', '-', '없음'] },
          { name: '배수상태', ratings: ['원활', '-', '습윤', '-', '물고임'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '수목', '보행로', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 7,
        additionalCount: 4
      },
      '다리': {
        facility: [
          { name: '세굴', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '침하', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '균열', section: '기초부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '기초부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '균열', section: '교각부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '교각부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '교각부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '변형', section: '교각부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '부식', section: '교각부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '유간', section: '교각부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '균열', section: '교면부(상판)', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '교면부(상판)', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '교면부(상판)', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '부식', section: '교면부(상판)', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '균열', section: '난간', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '난간', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '난간', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '변형', section: '난간', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '부식', section: '난간', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '유간', section: '난간', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '지당', '수목', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 20,
        additionalCount: 4
      },
      '지당': {
        facility: [
          { name: '균열', section: '바닥부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '바닥부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '바닥부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '퇴적', section: '바닥부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '침하', section: '바닥부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '누수', section: '바닥부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '균열', section: '측벽부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '측벽부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '측벽부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '변형', section: '측벽부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '누수흔', section: '측벽부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '균열', section: '중도', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '중도', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '수목 유무', section: '중도', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '수목 기울기', section: '중도', ratings: ['5° 미만', '5~10° 미만', '10~15°미만', '15~20°미만', '20° 초과'] },
          { name: '입수구', section: '배수시설', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] },
          { name: '출수구', section: '배수시설', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '수목', '보행로', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 17,
        additionalCount: 4
      },
      '문': {
        facility: [
          { name: '세굴', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '침하', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '우수침투흔', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '균열', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '누수흔', section: '벽체부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '변형', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '부식', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '균열', section: '지붕부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '지붕부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '누수흔', section: '지붕부', ratings: ['없음', '-', '-', '-', '있음'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '수목', '보행로', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 12,
        additionalCount: 4
      },
      '담장': {
        facility: [
          { name: '세굴', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '침하', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '우수침투흔', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '균열', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '누수흔', section: '벽체부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '줄눈 유실', section: '벽체부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '변형', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '부식', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '균열', section: '지붕부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '지붕부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '누수흔', section: '지붕부', ratings: ['없음', '-', '-', '-', '있음'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '수목', '보행로', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 13,
        additionalCount: 4
      },
      '굴뚝': {
        facility: [
          { name: '세굴', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '침하', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '우수침투흔', section: '기초부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '균열', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '누수흔', section: '벽체부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '변형', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '부식', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '균열', section: '지붕부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '지붕부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '누수흔', section: '지붕부', ratings: ['없음', '-', '-', '-', '있음'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '수목', '보행로', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 12,
        additionalCount: 4
      },
      '배수시설': {
        facility: [
          { name: '균열', section: '바닥부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '바닥부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '바닥부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '퇴적', section: '바닥부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '침하', section: '바닥부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '누수', section: '바닥부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '균열', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '변형', section: '벽체부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '누수', section: '벽체부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '균열', section: '덮개부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '파손·탈락', section: '덮개부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '열화', section: '덮개부', ratings: ['없음', '경미', '약간 심각', '심각', '매우 심각'] },
          { name: '퇴적', section: '덮개부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '침하', section: '덮개부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '누수', section: '덮개부', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '피복 재료', ratings: ['매끄러운 포장', '마사토', '잔디', '낙엽있는 삼림지', '밀집잔디 삼림지'] },
          { name: '배수 상태', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '수목', '보행로', '기타'] }
        ],
        facilityCount: 19,
        additionalCount: 2
      },
      '단일목': {
        facility: [
          { name: '복토·심토', section: '뿌리', ratings: ['없음', '경미', '국부', '광대', '심각'] },
          { name: '뿌리들림', section: '뿌리', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '뿌리감기', section: '뿌리', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '결함', section: '뿌리', ratings: ['없음', '-', '경미', '-', '있음'] },
          { name: '결함', section: '근원', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '병충해', section: '근원', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '밀도', section: '줄기', ratings: ['정상', '-', '-', '-', '쇠퇴(50%이하)'] },
          { name: '엽색', section: '줄기', ratings: ['진한녹색', '-', '녹색', '-', '변색'] },
          { name: '결함', section: '줄기', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '병충해', section: '줄기', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '고사지', section: '가지', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '결함', section: '가지', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '병충해', section: '가지', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '기울기', ratings: ['5° 미만', '5~10° 미만', '10~15°미만', '15~20°미만', '20° 초과'] },
          { name: '토사결합력', ratings: ['매우 견고', '견고', '중간', '느슨', '매우 느슨'] },
          { name: '토양상태', ratings: ['양토', '식양토', '마사토', '사질토', '진흙'] },
          { name: '외과수술', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '보강시설', ratings: ['있음', '-', '-', '-', '필요'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '보행로', '수목', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 18,
        additionalCount: 4
      },
      '군락': {
        facility: [
          { name: '복토·심토', section: '뿌리', ratings: ['없음', '경미', '국부', '광대', '심각'] },
          { name: '뿌리들림', section: '뿌리', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '뿌리감기', section: '뿌리', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '결함', section: '뿌리', ratings: ['없음', '-', '경미', '-', '있음'] },
          { name: '결함', section: '근원', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '병충해', section: '근원', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '밀도', section: '줄기', ratings: ['정상', '-', '-', '-', '쇠퇴(50%이하)'] },
          { name: '엽색', section: '줄기', ratings: ['진한녹색', '-', '녹색', '-', '변색'] },
          { name: '결함', section: '줄기', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '병충해', section: '줄기', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '고사지', section: '가지', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '결함', section: '가지', ratings: ['없음', '-', '경미', '-', '심각'] },
          { name: '병충해', section: '가지', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '기울기', ratings: ['5° 미만', '5~10° 미만', '10~15°미만', '15~20°미만', '20° 초과'] },
          { name: '토사결합력', ratings: ['매우 견고', '견고', '중간', '느슨', '매우 느슨'] },
          { name: '토양상태', ratings: ['양토', '식양토', '마사토', '사질토', '진흙'] },
          { name: '외과수술', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '보강시설', ratings: ['있음', '-', '-', '-', '필요'] }
        ],
        additional: [
          { name: '유무', ratings: ['없음', '-', '-', '-', '있음'] },
          { name: '유형', ratings: ['건조물', '시설물', '보행로', '수목', '기타'] },
          { name: '수로', ratings: ['원활', '-', '-', '-', '막힘'] },
          { name: '집수정', ratings: ['원활', '-', '부분 막힘', '-', '막힘'] }
        ],
        facilityCount: 18,
        additionalCount: 4
      }
    };

    // 점검 대상별 예상피해 유형 정의
    const damageTypesByTarget = {
      '비탈면': ['침식', '이완', '붕괴'],
      '석축 및 옹벽': ['손상', '침하', '전도', '배부름', '붕괴'],
      '지반': ['침하', '공동', '침수', '침식', '손상'],
      '다리': ['침하', '손상', '전도', '배부름', '붕괴'],
      '지당': ['손상', '배부름', '퇴적', '침하', '붕괴'],
      '문': ['손상', '전도', '붕괴'],
      '담장': ['손상', '전도', '붕괴', '고사'],
      '굴뚝': ['손상', '전도', '붕괴'],
      '배수시설': ['손상', '전도', '배부름', '퇴적', '침하', '붕괴'],
      '단일목': ['부러짐', '도복'],
      '군락': ['부러짐', '도복']
    };

    // 일반현황 테이블 렌더링
    function renderGeneralInfo(targetType) {
      const container = document.getElementById('generalInfoContainer');
      if (!container) return;

      const config = generalInfoByTarget[targetType];
      if (!config) {
        container.innerHTML = '<p>일반현황 정보가 없습니다.</p>';
        return;
      }

      // facilityInfo 키에서 데이터 가져오기 (inspection-general.html에서 저장한 키)
      const facilityData = inspectionData.facilityInfo || {};
      console.log('Facility data:', facilityData);

      let html = `<table class="status-table">
        <tr>
          <th>항목</th>
          <td colspan="3">내용</td>
          <th>비고</th>
        </tr>`;

      config.fields.forEach(field => {
        html += '<tr>';
        html += `<th>${field.name}</th>`;

        if (field.type === 'text') {
          const value = facilityData[field.key] || '';
          html += `<td colspan="3">${value || '-'}</td>`;
        } else if (field.type === 'checkbox') {
          html += '<td colspan="3"><div class="option-group">';
          const savedValues = facilityData[field.key] || [];
          field.options.forEach(opt => {
            const isChecked = Array.isArray(savedValues) ? savedValues.includes(opt) : savedValues === opt;
            html += `<span class="option-item"><span class="check-box${isChecked ? ' checked' : ''}"></span> <span class="check-label">${opt}</span></span>`;
          });
          html += '</div></td>';
        } else if (field.type === 'dimension') {
          const length = facilityData.length || '';
          const height = facilityData.height || '';
          html += `<td colspan="3">길이: ${length || '-'} / 높이: ${height || '-'}</td>`;
        } else if (field.type === 'tree') {
          const species = facilityData.species || '';
          const treeHeight = facilityData.treeHeight || facilityData.height || '';
          const dbh = facilityData.dbh || '';
          const crownWidth = facilityData.crownWidth || '';
          html += `<td colspan="3">수종: ${species || '-'} / 수고: ${treeHeight || '-'}m / 흉고: ${dbh || '-'}cm / 수관폭: ${crownWidth || '-'}m</td>`;
        } else if (field.type === 'tree2') {
          const species = facilityData.species || '';
          const treeHeight = facilityData.treeHeight || facilityData.height || '';
          html += `<td colspan="3">수종: ${species || '-'} / 수고: ${treeHeight || '-'}m</td>`;
        }

        html += '<td></td></tr>';
      });

      html += '</table>';
      container.innerHTML = html;
    }

    // 점검항목 테이블 렌더링
    function renderChecklist(targetType) {
      const container = document.getElementById('checklistContainer');
      if (!container) return;

      const config = checklistItemsByTarget[targetType];
      if (!config) {
        // 기본 양식 (설정이 없는 경우)
        container.innerHTML = '<p>점검항목 정보가 준비 중입니다.</p>';
        return;
      }

      let html = `<table class="checklist-table">
        <colgroup>
          <col style="width: 50px;">
          <col style="width: 70px;">
          <col style="width: 90px;">
          <col style="width: 90px;">
          <col style="width: 90px;">
          <col style="width: 90px;">
          <col style="width: 90px;">
          <col style="width: 70px;">
        </colgroup>
        <thead>
          <tr>
            <th colspan="2" rowspan="2">구분</th>
            <th colspan="5">평가 척도</th>
            <th rowspan="2">비고</th>
          </tr>
          <tr>
            <th>안전</th>
            <th>관심</th>
            <th>주의</th>
            <th>경계</th>
            <th>위험</th>
          </tr>
        </thead>
        <tbody>`;

      // 당해시설 항목
      const facilityItems = config.facility || [];
      const facilityCount = config.facilityCount || facilityItems.length;

      facilityItems.forEach((item, index) => {
        html += '<tr>';
        if (index === 0) {
          html += `<td rowspan="${facilityCount}" class="sub-header">당해<br>시설</td>`;
        }
        html += `<td class="row-header">${item.name}</td>`;

        // 저장된 값 찾기
        const savedItem = inspectionData.checklist?.facility?.find(i => i.item === item.name);
        const savedValue = savedItem?.rating || '';

        item.ratings.forEach(rating => {
          if (rating === '-') {
            html += '<td>-</td>';
          } else {
            const isChecked = savedValue === rating;
            html += `<td><span class="check-cell"><span class="check-box${isChecked ? ' checked' : ''}"></span> ${rating}</span></td>`;
          }
        });

        html += `<td>${savedItem?.remark || ''}</td>`;
        html += '</tr>';
      });

      // 추가 피해요소 항목
      const additionalItems = config.additional || [];
      const additionalCount = config.additionalCount || additionalItems.length;

      additionalItems.forEach((item, index) => {
        html += '<tr>';
        if (index === 0) {
          html += `<td rowspan="${additionalCount}" class="sub-header">추가<br>피해<br>요소</td>`;
        }
        html += `<td class="row-header">${item.name}</td>`;

        // 저장된 값 찾기
        const savedItem = inspectionData.checklist?.additional?.find(i => i.item === item.name);
        const savedValue = savedItem?.rating || '';

        item.ratings.forEach(rating => {
          if (rating === '-') {
            html += '<td>-</td>';
          } else {
            const isChecked = savedValue === rating;
            html += `<td><span class="check-cell"><span class="check-box${isChecked ? ' checked' : ''}"></span> ${rating}</span></td>`;
          }
        });

        html += `<td>${savedItem?.remark || ''}</td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // 예상피해 유형 렌더링
    function renderDamageTypes(targetType) {
      const container = document.getElementById('damageTypeContainer');
      if (!container) return;

      const types = damageTypesByTarget[targetType] || ['손상', '침하', '전도', '배부름', '붕괴'];
      const savedTypes = inspectionData.final?.damageTypes || [];

      let html = '';
      types.forEach(type => {
        const isChecked = savedTypes.includes(type);
        html += `<span class="option-item" data-type="${type}"><span class="check-box${isChecked ? ' checked' : ''}"></span> <span class="check-label">${type}</span></span>`;
      });

      container.innerHTML = html;
    }

    // 점검 대상에 따라 보고서 양식 렌더링
    function renderReportByTarget(targetType) {
      console.log('Rendering report for target:', targetType);
      renderGeneralInfo(targetType);
      renderChecklist(targetType);
      renderDamageTypes(targetType);
    }

    // 페이지 로드 시 점검 대상별 렌더링 실행
    renderReportByTarget(target);

    // 이전 버튼
    function goBack() {
      window.location.href = `inspection-final.html?site=${siteId}&type=${inspectionType}&target=${encodeURIComponent(target)}`;
    }

    // 제출하기
    function submitReport() {
      document.getElementById('submitModal').classList.add('active');
    }

    // 보고서 다운로드 (PNG)
    async function downloadReport() {
      const reportEl = document.querySelector('.report-preview');
      if (!reportEl) {
        alert('보고서를 찾을 수 없습니다.');
        return;
      }

      try {
        // 모달 숨기기
        document.getElementById('submitModal').classList.remove('active');

        // html2canvas로 캡처
        const canvas = await html2canvas(reportEl, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#FFFFFF',
          logging: false
        });

        // PNG 다운로드
        const targetText = document.getElementById('targetDisplay')?.textContent || '보고서';
        const dateText = document.getElementById('dateDisplay')?.textContent || new Date().toISOString().slice(0, 10);
        const fileName = `안전점검보고서_${targetText}_${dateText.replace(/\./g, '')}.png`;

        // Blob으로 변환하여 다운로드
        canvas.toBlob(function(blob) {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.download = fileName;
          link.href = url;
          link.click();
          URL.revokeObjectURL(url);

          // 다운로드 시작 후 잠시 대기 후 완료 모달 표시
          setTimeout(() => {
            document.getElementById('downloadModal').classList.add('active');
          }, 500);
        }, 'image/png');

      } catch (error) {
        console.error('PNG 다운로드 오류:', error);
        alert('보고서 다운로드에 실패했습니다.');
      }
    }

    // 다운로드 모달 닫기
    function closeDownloadModal() {
      document.getElementById('downloadModal').classList.remove('active');
    }

    // 홈으로
    function goHome() {
      window.location.href = 'index.html';
    }

    // 모달 바깥 클릭 시 닫기
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    });

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
          overlay.classList.remove('active');
        });
      }
    });

    // ============================================================
    // 실제 점검표 데이터 로딩 (Phase 5)
    // ============================================================

    // 점검표 데이터 로드 및 렌더링
    async function loadInspectionData(inspectionId) {
      try {
        console.log('Loading inspection data for:', inspectionId);

        // 데이터 로더를 통해 점검표 로드
        const inspection = await DataLoader.loadInspection(inspectionId);

        if (!inspection) {
          console.error('Inspection not found:', inspectionId);
          return;
        }

        console.log('Loaded inspection:', inspection);
        window.currentInspection = inspection;

        // 페이지 렌더링
        renderInspectionData(inspection);
        renderPhotos(inspection);

      } catch (error) {
        console.error('Failed to load inspection:', error);
      }
    }

    // 점검표 데이터를 페이지에 렌더링
    function renderInspectionData(inspection) {
      // 헤더 정보
      const inspectionTypeEl = document.getElementById('inspectionTypeDisplay');
      const siteEl = document.getElementById('siteDisplay');
      const targetEl = document.getElementById('targetDisplay');
      const dateEl = document.getElementById('dateDisplay');

      if (inspectionTypeEl) inspectionTypeEl.textContent = inspection.targetType || '정기점검';
      if (siteEl) siteEl.textContent = inspection.site || '낙선재 권역';
      if (targetEl) targetEl.textContent = inspection.targetName || '';
      if (dateEl) dateEl.textContent = inspection.inspectionDate || new Date().toLocaleDateString('ko-KR');

      // 점검자 정보 (있는 경우)
      const inspectorEl = document.querySelector('[data-field="inspector"]');
      if (inspectorEl && inspection.inspector) {
        inspectorEl.textContent = inspection.inspector;
      }

      // 일반 현황 정보
      if (inspection.generalInfo) {
        renderGeneralInfo(inspection.generalInfo);
      }

      // 점검 항목
      if (inspection.checklistItems) {
        console.log('Rendering checklist items:', inspection.checklistItems);
        // 점검 항목 구조는 타입마다 다르므로 일반적인 처리만
        // 실제 세부 렌더링은 타입별로 처리 필요
      }

      // 종합 판정
      if (inspection.overallAssessment) {
        renderOverallAssessment(inspection.overallAssessment);
      }
    }

    // 일반 현황 정보 렌더링
    function renderGeneralInfo(generalInfo) {
      // 위치
      const locationEl = document.querySelector('[data-field="location"]');
      if (locationEl && generalInfo.location) {
        locationEl.textContent = generalInfo.location;
      }

      // 코드
      const codeEl = document.querySelector('[data-field="code"]');
      if (codeEl && generalInfo.code) {
        codeEl.textContent = generalInfo.code;
      }

      // extractedText가 있으면 표시 (디버깅용)
      if (generalInfo.extractedText) {
        console.log('Extracted text available:', generalInfo.extractedText.substring(0, 200) + '...');
      }
    }

    // 종합 판정 렌더링
    function renderOverallAssessment(assessment) {
      // 판정 등급 표시
      const ratingEl = document.querySelector('[data-field="rating"]');
      if (ratingEl && assessment.rating) {
        ratingEl.textContent = assessment.rating;
        // 등급별 색상
        const colors = {
          '안전': '#4CAF50',
          '관심': '#2196F3',
          '주의': '#FF9800',
          '경계': '#FF5722',
          '위험': '#F44336'
        };
        ratingEl.style.color = colors[assessment.rating] || '#333';
      }

      // 종합 판정 등급 (기존 선택 UI)
      const ratingEls = document.querySelectorAll('.report-judgment__item');
      ratingEls.forEach(el => {
        const itemRating = el.getAttribute('data-rating');
        if (itemRating === assessment.rating) {
          el.classList.add('report-judgment__item--selected');
        } else {
          el.classList.remove('report-judgment__item--selected');
        }
      });

      // 점검자 의견
      const opinionEl = document.querySelector('[data-field="inspectorOpinion"]');
      if (opinionEl && assessment.inspectorOpinion) {
        opinionEl.textContent = assessment.inspectorOpinion;
      }
    }

    // 사진 렌더링
    function renderPhotos(inspection) {
      if (!inspection.photos || inspection.photos.length === 0) {
        console.warn('No photos found for inspection:', inspection.id);
        return;
      }

      console.log('Rendering photos:', inspection.photos.length);

      // 사진 URL 생성
      const photoUrls = DataLoader.getPhotoUrls(inspection);

      // 사진 섹션 및 컨테이너 찾기
      const photoSection = document.getElementById('photoSection');
      const photoContainer = document.getElementById('photoContainer');

      if (photoContainer && photoUrls.length > 0) {
        // 사진 섹션 표시
        if (photoSection) {
          photoSection.style.display = 'block';
        }

        // 썸네일 그리드 생성
        photoContainer.innerHTML = photoUrls.map((url, index) => `
          <img src="${url}"
               alt="점검 사진 ${index + 1}"
               class="photo-thumbnail"
               onclick="openPhotoGallery(${index})"
               style="width: 150px; height: 150px; object-fit: cover; cursor: pointer; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
               onerror="console.error('Failed to load:', this.src); this.style.display='none';">
        `).join('');

        console.log('Photos rendered successfully:', photoUrls.length);
      } else {
        console.warn('Photo container not found or no photo URLs');
      }
    }

    // 사진 갤러리 열기
    function openPhotoGallery(startIndex) {
      if (!window.currentInspection || !window.currentInspection.photos) {
        console.error('No inspection data available');
        return;
      }

      const photoUrls = DataLoader.getPhotoUrls(window.currentInspection);

      // PhotoGallery 모듈 사용
      const galleryContainer = document.getElementById('photoGalleryContainer') ||
                              document.body.appendChild(Object.assign(document.createElement('div'), {id: 'photoGalleryContainer'}));

      PhotoGallery.init('photoGalleryContainer', photoUrls);
      PhotoGallery.openModal(startIndex);
    }

    // 페이지 로드 시 실행
    window.addEventListener('DOMContentLoaded', async function() {
      console.log('Page loaded, inspectionId:', inspectionId);

      if (inspectionId) {
        // 새로운 방식: inspection ID로 데이터 로드
        await loadInspectionData(inspectionId);
      } else {
        // 기존 방식: sessionStorage 또는 URL 파라미터 사용
        console.log('Using legacy flow (no inspection ID)');
        updateBasicInfo();
        updateResultInfo();
        updateFinalInfo();
      }
    });
  </script>
</body>
</html>
