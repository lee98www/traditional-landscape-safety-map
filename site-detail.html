<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>대상지 상세 정보 | 전통조경 안전지도 시범서비스</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/reset.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      height: 100vh;
      overflow: hidden;
    }

    /* Map Container - 전체 화면 */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    /* Sidebar */
    .sidebar {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
      width: 240px;
    }

    .sidebar__logo {
      display: inline-flex;
      align-items: center;
      padding: 10px 20px;
      background-color: var(--color-logo-bg);
      border-radius: var(--radius-full);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--color-logo-text);
      text-decoration: none;
      border: 1px solid #D4E8FF;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .sidebar__logo:hover {
      background-color: #D4E8FF;
    }

    .sidebar__menu {
      background: var(--color-bg-white);
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      font-size: var(--font-size-base);
      color: var(--color-text-primary);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      border-bottom: 1px solid #F0F0F0;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item:hover {
      background: #F5F9FC;
    }

    .menu-item.active {
      background: var(--color-primary-light);
      color: var(--color-primary);
      font-weight: var(--font-weight-medium);
    }

    .menu-item__icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    /* Modal Content */
    .modal {
      background: var(--color-bg-white);
      border-radius: 12px;
      max-width: 900px;
      max-height: 85vh;
      width: 90%;
      overflow: hidden;
      box-shadow: 0 16px 48px rgba(0,0,0,0.2);
    }

    .modal__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 1px solid var(--color-border-light);
    }

    .modal__title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
    }

    .modal__close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transition-fast);
    }

    .modal__close:hover {
      background: #F0F0F0;
    }

    .modal__close svg {
      width: 20px;
      height: 20px;
    }

    .modal__body {
      padding: 24px;
      max-height: calc(85vh - 60px);
      overflow-y: auto;
    }

    /* 기본 정보 테이블 */
    .info-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm);
    }

    .info-table th,
    .info-table td {
      padding: 12px 16px;
      border: 1px solid #E0E0E0;
      text-align: left;
    }

    .info-table th {
      background: #4A7A8C;
      color: white;
      font-weight: var(--font-weight-medium);
      width: 140px;
    }

    .info-table td {
      background: white;
    }

    .info-table .section-header {
      background: #5A8A9C;
      color: white;
      text-align: center;
      font-weight: var(--font-weight-semibold);
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .checkbox-item input {
      width: 16px;
      height: 16px;
    }

    .check-mark {
      display: inline-block;
      width: 12px;
      height: 12px;
      background: var(--color-primary);
      border-radius: 50%;
      margin-right: 6px;
    }

    /* 이력 오버레이 (재해/수리) */
    .history-overlay {
      position: absolute;
      top: 0;
      left: 260px;
      right: 0;
      bottom: 0;
      z-index: 50;
      pointer-events: none;
      display: none;
    }

    .history-overlay.active {
      display: block;
    }

    /* 상단 필터 바 */
    .filter-bar {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      gap: 16px;
      align-items: center;
      pointer-events: auto;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-label {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      white-space: nowrap;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid #DDD;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    /* 범례 */
    .legend {
      position: absolute;
      bottom: 30px;
      right: 30px;
      background: var(--color-bg-white);
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      padding: 16px;
      min-width: 160px;
      pointer-events: auto;
    }

    .legend__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: var(--font-weight-semibold);
    }

    .legend__toggle {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .legend__item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .legend__item:last-child {
      margin-bottom: 0;
    }

    .legend__color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }

    /* 재해 범례 색상 */
    .legend__color--disaster-high { background: #E53935; }
    .legend__color--disaster-mid { background: #FB8C00; }
    .legend__color--disaster-low { background: #FFD54F; }

    /* 수리 범례 색상 */
    .legend__color--repair-high { background: #8E24AA; }
    .legend__color--repair-mid { background: #AB47BC; }
    .legend__color--repair-low { background: #CE93D8; }

    /* 경고 배너 */
    .warning-banner {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
      pointer-events: auto;
    }

    /* 점검 이력 팝업 */
    .inspection-popup {
      position: absolute;
      background: var(--color-bg-white);
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      padding: 16px;
      min-width: 200px;
      z-index: 150;
      display: none;
    }

    .inspection-popup.active {
      display: block;
    }

    .popup-item {
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
      transition: background var(--transition-fast);
    }

    .popup-item:hover {
      background: #F5F5F5;
    }

    /* 점검 이력 마커들 */
    .inspection-markers {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 60;
      display: none;
    }

    .inspection-markers.active {
      display: block;
    }

    /* 수리 이역 서브메뉴 컨테이너 */
    .repair-submenu-container {
      margin-top: 8px;
      display: none;
    }

    .repair-submenu-container.active {
      display: block;
    }

    .submenu-label {
      font-size: 11px;
      font-weight: 600;
      color: #666;
      padding: 0 16px 6px 16px;
    }

    /* 수리 이력 서브메뉴 */
    .repair-submenu {
      background: var(--color-bg-white);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .submenu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      font-size: 13px;
      color: var(--color-text-primary);
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      border-bottom: 1px solid #F0F0F0;
    }

    .submenu-item:last-child {
      border-bottom: none;
    }

    .submenu-item:hover {
      background: #F5F9FC;
    }

    .submenu-item.active {
      background: var(--color-primary-light);
      color: var(--color-primary);
    }

    .submenu-item__radio {
      width: 16px;
      height: 16px;
      border: 2px solid #CCC;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .submenu-item.active .submenu-item__radio {
      border-color: var(--color-primary);
    }

    .submenu-item__radio-inner {
      width: 8px;
      height: 8px;
      background: var(--color-primary);
      border-radius: 50%;
      display: none;
    }

    .submenu-item.active .submenu-item__radio-inner {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Google Map -->
  <div id="map"></div>

  <!-- Sidebar -->
  <div class="sidebar">
    <a href="index.html" class="sidebar__logo">전통조경 안전지도 시범서비스</a>

    <div class="sidebar__menu">
      <button class="menu-item" onclick="showBasicInfo()">
        <svg class="menu-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 16v-4"/>
          <path d="M12 8h.01"/>
        </svg>
        기본 정보
      </button>
      <button class="menu-item" onclick="showInspectionHistory()">
        <svg class="menu-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        점검 이력
      </button>
      <button class="menu-item" onclick="showDisasterHistory()">
        <svg class="menu-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
        </svg>
        재해 이력
      </button>
      <button class="menu-item" onclick="showRepairHistory()">
        <svg class="menu-item__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
        </svg>
        수리 이력
      </button>
    </div>

    <!-- 수리 이력 서브메뉴 -->
    <div class="repair-submenu-container">
      <div class="repair-submenu" id="repairSubmenu">
        <button class="submenu-item active" onclick="selectRepairFilter('all')">
          <span class="submenu-item__radio"><span class="submenu-item__radio-inner"></span></span>
          모두보기
        </button>
        <button class="submenu-item" onclick="selectRepairFilter('flood')">
          <span class="submenu-item__radio"><span class="submenu-item__radio-inner"></span></span>
          범람 위험 요소
        </button>
        <button class="submenu-item" onclick="selectRepairFilter('terrain')">
          <span class="submenu-item__radio"><span class="submenu-item__radio-inner"></span></span>
          인접 지형
        </button>
        <button class="submenu-item" onclick="selectRepairFilter('surrounding')">
          <span class="submenu-item__radio"><span class="submenu-item__radio-inner"></span></span>
          주변 영향
        </button>
        <button class="submenu-item" onclick="selectRepairFilter('elevation')">
          <span class="submenu-item__radio"><span class="submenu-item__radio-inner"></span></span>
          고저차
        </button>
        <button class="submenu-item" onclick="selectRepairFilter('hydraulic')">
          <span class="submenu-item__radio"><span class="submenu-item__radio-inner"></span></span>
          수리 조건
        </button>
        <button class="submenu-item" onclick="selectRepairFilter('rainfall')">
          <span class="submenu-item__radio"><span class="submenu-item__radio-inner"></span></span>
          강우 이력
        </button>
      </div>
    </div>
  </div>

  <!-- 기본 정보 모달 -->
  <div class="modal-overlay" id="basicInfoModal">
    <div class="modal">
      <div class="modal__header">
        <h2 class="modal__title">기본 정보</h2>
        <button class="modal__close" onclick="closeModal('basicInfoModal')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18"/>
            <path d="M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="modal__body">
        <table class="info-table">
          <tr>
            <th rowspan="4" class="section-header">국가<br>유산<br>개요</th>
            <th>국가유산명</th>
            <td>창덕궁 낙선재 권역</td>
            <th rowspan="5" class="section-header">국가<br>유산<br>관리</th>
            <th>종합정비계획</th>
            <td><span class="check-mark"></span></td>
          </tr>
          <tr>
            <th>국가유산유형</th>
            <td>사적</td>
            <th>정기조사</th>
            <td><span class="check-mark"></span></td>
          </tr>
          <tr>
            <th>소재지</th>
            <td>서울특별시 종로구 율곡로 99-0</td>
            <th>돌봄사업</th>
            <td>-</td>
          </tr>
          <tr>
            <th>소유자/관리자</th>
            <td>국가유산청 창덕궁관리소</td>
            <th>모니터링</th>
            <td><span class="check-mark"></span></td>
          </tr>
          <tr>
            <th rowspan="6" class="section-header">주변<br>환경</th>
            <th>범람위험요소</th>
            <td colspan="2">
              <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" checked disabled> 강, 하천</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 계곡</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 저수지</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 바다</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 기타</label>
              </div>
            </td>
            <th>국가유산지킴이</th>
            <td><span class="check-mark"></span></td>
          </tr>
          <tr>
            <th>인접지형</th>
            <td colspan="4">
              <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" checked disabled> 경사</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 옹벽</label>
                <label class="checkbox-item"><input type="checkbox" checked disabled> 전도위험</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 절개지</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 기타</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>주변 영향</th>
            <td colspan="4">
              <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" disabled> 습해</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 공해</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 염해</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 진동</label>
                <label class="checkbox-item"><input type="checkbox" disabled> 기타</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>고저차</th>
            <td colspan="4">
              당해 국가유산이 주변지형에 비해 &nbsp;
              <label class="checkbox-item"><input type="checkbox" checked disabled> 낮음</label>
              <label class="checkbox-item"><input type="checkbox" disabled> 높음</label>
            </td>
          </tr>
          <tr>
            <th>수리조건</th>
            <td colspan="4">
              <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" checked disabled> dry</label>
                <label class="checkbox-item"><input type="checkbox" disabled> damp</label>
                <label class="checkbox-item"><input type="checkbox" disabled> wet</label>
                <label class="checkbox-item"><input type="checkbox" disabled> dripping</label>
                <label class="checkbox-item"><input type="checkbox" disabled> flowing</label>
              </div>
            </td>
          </tr>
          <tr>
            <th>강우이력</th>
            <td colspan="4">해당 지역 최근 10개년 최대 일강우강도 누년 평균값과 최근 2개년 최대 강우량</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- 재해 이력 오버레이 -->
  <div class="history-overlay" id="disasterOverlay">
    <div class="filter-bar">
      <div class="filter-group">
        <label class="filter-label">전통조경요소</label>
        <select class="filter-select" id="disasterElementFilter" onchange="applyDisasterFilters()">
          <option value="all" selected>모두보기</option>
          <option value="석축">석축</option>
          <option value="옹벽">옹벽</option>
          <option value="담장">담장</option>
          <option value="수목">수목</option>
          <option value="문">문</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">재해</label>
        <select class="filter-select" id="disasterTypeFilter" onchange="applyDisasterFilters()">
          <option value="all" selected>모두보기</option>
          <option value="호우">호우</option>
          <option value="강풍">강풍</option>
          <option value="태풍">태풍</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">연도</label>
        <select class="filter-select" id="disasterYearFilter" onchange="applyDisasterFilters()">
          <option value="all" selected>모두보기</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
          <option value="2021">2021</option>
          <option value="2020">2020</option>
          <option value="2019">2019</option>
          <option value="2017">2017</option>
        </select>
      </div>
    </div>
    <div class="warning-banner">
      ※ 본 지도의 조사 영역과 결과는 실제 조사 결과가 아닌 이해를 돕기 위한 예시 이미지 입니다
    </div>
    <div class="legend" id="disasterLegend">
      <div class="legend__header">
        재해 이력 범례
        <svg class="legend__toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 15l-6-6-6 6"/>
        </svg>
      </div>
      <div class="legend__item">
        <span class="legend__color legend__color--disaster-high"></span>
        10회 이상 발생
      </div>
      <div class="legend__item">
        <span class="legend__color legend__color--disaster-mid"></span>
        5회 이상 발생
      </div>
      <div class="legend__item">
        <span class="legend__color legend__color--disaster-low"></span>
        1회 이상 발생
      </div>
    </div>
  </div>

  <!-- 수리 이력 오버레이 -->
  <div class="history-overlay" id="repairOverlay">
    <div class="warning-banner">
      ※ 본 지도의 조사 영역과 결과는 실제 조사 결과가 아닌 이해를 돕기 위한 예시 이미지 입니다
    </div>
    <div class="legend" id="repairLegend">
      <div class="legend__header">
        수리 이력 범례
        <svg class="legend__toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 15l-6-6-6 6"/>
        </svg>
      </div>
      <div class="legend__item">
        <span class="legend__color legend__color--repair-high"></span>
        10회 이상
      </div>
      <div class="legend__item">
        <span class="legend__color legend__color--repair-mid"></span>
        5회 이상
      </div>
      <div class="legend__item">
        <span class="legend__color legend__color--repair-low"></span>
        1회 이상
      </div>
    </div>
  </div>

  <!-- 점검 이력 팝업 -->
  <div class="inspection-popup" id="inspectionPopup">
    <div class="popup-item" onclick="showReport()">안전 점검 보고서</div>
    <div class="popup-item" onclick="showPhotos()">사진</div>
    <div class="popup-item" onclick="openMetafort()">메타포트</div>
  </div>

  <!-- Config -->
  <script src="config.js"></script>

  <!-- 데이터 로더 및 GIS 렌더러 -->
  <script src="js/data-loader.js"></script>
  <script src="js/gis-renderer.js"></script>

  <script>
    let map;
    let mainMarker;
    let inspectionMarkers = [];
    let polygons = [];
    let currentMode = null;
    let inspectionsData = [];
    let gisData = {};
    let allDisasterHistory = [];
    let allRepairHistory = [];

    // 대상지 좌표 (창덕궁 낙선재)
    const siteInfo = DataLoader.getSiteInfo();
    const siteLocation = siteInfo.center;

    // 더미 폴리곤 데이터는 삭제하고 실제 데이터를 JSON에서 로드합니다
    // (아래 주석 처리된 코드는 참고용으로 남겨둠)
    /*
    // 재해 이력 폴리곤 데이터 - 매우 작은 크기, 좁은 범위 (중심: 37.5795, 126.9910)
    const disasterPolygons_OLD = [
      // 고위험 (빨강) - 4개
      { paths: [
        { lat: 37.57962, lng: 126.99065 }, { lat: 37.57968, lng: 126.99072 },
        { lat: 37.57963, lng: 126.99078 }, { lat: 37.57957, lng: 126.99070 }
      ], color: '#E53935', level: 'high' },
      { paths: [
        { lat: 37.57985, lng: 126.99120 }, { lat: 37.57990, lng: 126.99125 }, { lat: 37.57992, lng: 126.99132 },
        { lat: 37.57986, lng: 126.99135 }, { lat: 37.57982, lng: 126.99128 }
      ], color: '#E53935', level: 'high' },
      { paths: [
        { lat: 37.57925, lng: 126.99085 }, { lat: 37.57932, lng: 126.99088 },
        { lat: 37.57930, lng: 126.99095 }, { lat: 37.57923, lng: 126.99092 }
      ], color: '#E53935', level: 'high' },
      { paths: [
        { lat: 37.57970, lng: 126.99145 }, { lat: 37.57976, lng: 126.99148 }, { lat: 37.57978, lng: 126.99154 },
        { lat: 37.57972, lng: 126.99156 }, { lat: 37.57968, lng: 126.99150 }
      ], color: '#E53935', level: 'high' },
      // 중위험 (주황) - 4개
      { paths: [
        { lat: 37.57945, lng: 126.99105 }, { lat: 37.57952, lng: 126.99108 },
        { lat: 37.57950, lng: 126.99115 }, { lat: 37.57943, lng: 126.99112 }
      ], color: '#FB8C00', level: 'mid' },
      { paths: [
        { lat: 37.57998, lng: 126.99095 }, { lat: 37.58003, lng: 126.99100 }, { lat: 37.58000, lng: 126.99107 },
        { lat: 37.57995, lng: 126.99102 }
      ], color: '#FB8C00', level: 'mid' },
      { paths: [
        { lat: 37.57938, lng: 126.99135 }, { lat: 37.57944, lng: 126.99138 }, { lat: 37.57946, lng: 126.99145 },
        { lat: 37.57940, lng: 126.99147 }, { lat: 37.57936, lng: 126.99140 }
      ], color: '#FB8C00', level: 'mid' },
      { paths: [
        { lat: 37.57978, lng: 126.99078 }, { lat: 37.57984, lng: 126.99082 },
        { lat: 37.57982, lng: 126.99088 }, { lat: 37.57976, lng: 126.99085 }
      ], color: '#FB8C00', level: 'mid' },
      // 저위험 (노랑) - 4개
      { paths: [
        { lat: 37.57955, lng: 126.99125 }, { lat: 37.57960, lng: 126.99128 },
        { lat: 37.57958, lng: 126.99134 }, { lat: 37.57953, lng: 126.99131 }
      ], color: '#FFD54F', level: 'low' },
      { paths: [
        { lat: 37.57990, lng: 126.99060 }, { lat: 37.57995, lng: 126.99063 }, { lat: 37.57993, lng: 126.99070 },
        { lat: 37.57988, lng: 126.99067 }
      ], color: '#FFD54F', level: 'low' },
      { paths: [
        { lat: 37.57918, lng: 126.99115 }, { lat: 37.57924, lng: 126.99118 }, { lat: 37.57926, lng: 126.99124 },
        { lat: 37.57920, lng: 126.99126 }, { lat: 37.57916, lng: 126.99120 }
      ], color: '#FFD54F', level: 'low' },
      { paths: [
        { lat: 37.57968, lng: 126.99098 }, { lat: 37.57973, lng: 126.99102 },
        { lat: 37.57970, lng: 126.99108 }, { lat: 37.57965, lng: 126.99104 }
      ], color: '#FFD54F', level: 'low' }
    ];
    */

    // 수리 이력 폴리곤 데이터도 JSON에서 로드합니다
    /*
    const repairPolygons_OLD = [
      // 수리 필요 높음 (보라) - 4개
      { paths: [
        { lat: 37.57942, lng: 126.99075 }, { lat: 37.57948, lng: 126.99080 },
        { lat: 37.57945, lng: 126.99087 }, { lat: 37.57939, lng: 126.99082 }
      ], color: '#8E24AA', level: 'high' },
      { paths: [
        { lat: 37.57975, lng: 126.99110 }, { lat: 37.57980, lng: 126.99115 }, { lat: 37.57982, lng: 126.99122 },
        { lat: 37.57976, lng: 126.99124 }, { lat: 37.57972, lng: 126.99117 }
      ], color: '#8E24AA', level: 'high' },
      { paths: [
        { lat: 37.57995, lng: 126.99082 }, { lat: 37.58000, lng: 126.99085 },
        { lat: 37.57998, lng: 126.99092 }, { lat: 37.57993, lng: 126.99089 }
      ], color: '#8E24AA', level: 'high' },
      { paths: [
        { lat: 37.57932, lng: 126.99140 }, { lat: 37.57938, lng: 126.99143 }, { lat: 37.57940, lng: 126.99150 },
        { lat: 37.57934, lng: 126.99152 }, { lat: 37.57930, lng: 126.99145 }
      ], color: '#8E24AA', level: 'high' },
      // 수리 필요 중간 (연보라) - 4개
      { paths: [
        { lat: 37.57958, lng: 126.99092 }, { lat: 37.57964, lng: 126.99095 },
        { lat: 37.57962, lng: 126.99102 }, { lat: 37.57956, lng: 126.99099 }
      ], color: '#AB47BC', level: 'mid' },
      { paths: [
        { lat: 37.57988, lng: 126.99135 }, { lat: 37.57993, lng: 126.99138 }, { lat: 37.57990, lng: 126.99145 },
        { lat: 37.57985, lng: 126.99142 }
      ], color: '#AB47BC', level: 'mid' },
      { paths: [
        { lat: 37.57922, lng: 126.99102 }, { lat: 37.57928, lng: 126.99105 }, { lat: 37.57930, lng: 126.99112 },
        { lat: 37.57924, lng: 126.99114 }, { lat: 37.57920, lng: 126.99107 }
      ], color: '#AB47BC', level: 'mid' },
      { paths: [
        { lat: 37.57965, lng: 126.99058 }, { lat: 37.57970, lng: 126.99062 },
        { lat: 37.57968, lng: 126.99068 }, { lat: 37.57963, lng: 126.99065 }
      ], color: '#AB47BC', level: 'mid' },
      // 수리 필요 낮음 (연한 보라) - 4개
      { paths: [
        { lat: 37.57948, lng: 126.99118 }, { lat: 37.57953, lng: 126.99122 },
        { lat: 37.57950, lng: 126.99128 }, { lat: 37.57945, lng: 126.99125 }
      ], color: '#CE93D8', level: 'low' },
      { paths: [
        { lat: 37.57982, lng: 126.99068 }, { lat: 37.57987, lng: 126.99072 }, { lat: 37.57985, lng: 126.99078 },
        { lat: 37.57980, lng: 126.99075 }
      ], color: '#CE93D8', level: 'low' },
      { paths: [
        { lat: 37.57935, lng: 126.99125 }, { lat: 37.57940, lng: 126.99128 }, { lat: 37.57942, lng: 126.99135 },
        { lat: 37.57936, lng: 126.99137 }, { lat: 37.57933, lng: 126.99130 }
      ], color: '#CE93D8', level: 'low' },
      { paths: [
        { lat: 37.58002, lng: 126.99115 }, { lat: 37.58007, lng: 126.99118 }, { lat: 37.58005, lng: 126.99125 },
        { lat: 37.58000, lng: 126.99122 }
      ], color: '#CE93D8', level: 'low' }
    ];
    */

    // Google Maps 초기화
    async function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: siteLocation,
        zoom: siteInfo.zoom,
        mapTypeId: 'satellite',
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });

      // GIS 렌더러 초기화
      GISRenderer.init(map);

      // 점검표 데이터 로드 (표시는 하지 않음 - 버튼 클릭 시에만 표시)
      inspectionsData = await DataLoader.loadAllInspections();
      console.log(`점검표 ${inspectionsData.length}개 로드 완료`);

      // GIS 데이터 로드만 수행 (렌더링은 하지 않음 - 버튼 클릭 시에만)
      gisData = await DataLoader.loadAllGIS();
      console.log('GIS 데이터 로드 완료 (렌더링 대기 중)');

      // 재해/수리 이력 데이터 로드
      allDisasterHistory = await DataLoader.loadDisasterHistory();
      allRepairHistory = await DataLoader.loadRepairHistory();
      console.log(`재해 이력 ${allDisasterHistory.length}개, 수리 이력 ${allRepairHistory.length}개 로드 완료`);
    }

    // 메뉴 활성화 상태 업데이트
    function setActiveMenu(index) {
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach((item, i) => {
        item.classList.toggle('active', i === index);
      });
    }

    // 모든 오버레이 숨기기
    function hideAllOverlays() {
      document.getElementById('disasterOverlay').classList.remove('active');
      document.getElementById('repairOverlay').classList.remove('active');
      document.querySelector('.repair-submenu-container').classList.remove('active');
      clearPolygons();
      clearInspectionMarkers();
      currentMode = null;
    }

    // 기본 정보 표시
    function showBasicInfo() {
      hideAllOverlays();
      setActiveMenu(0);
      document.getElementById('basicInfoModal').classList.add('active');
    }

    // 점검 이력 표시
    function showInspectionHistory() {
      hideAllOverlays();
      setActiveMenu(1);
      currentMode = 'inspection';

      // 실제 점검표 데이터로 마커 생성
      if (inspectionsData && inspectionsData.length > 0) {
        GISRenderer.addAllInspectionMarkers(inspectionsData, (inspection) => {
          // 클릭 시 모달 팝업 표시 (페이지 이동 대신)
          showInspectionModal(inspection);
        });
      } else {
        console.warn('점검표 데이터가 없습니다.');
      }
    }

    // 점검 상세 모달 표시 함수
    function showInspectionModal(inspection) {
      // 기존 모달이 있으면 제거
      const existingModal = document.querySelector('.inspection-modal');
      if (existingModal) {
        existingModal.remove();
      }

      // 등급별 색상 결정
      const getRatingColor = (rating) => {
        const colors = {
          '안전': '#4CAF50',
          '관심': '#2196F3',
          '주의': '#FF9800',
          '경계': '#FF5722',
          '위험': '#F44336'
        };
        return colors[rating] || '#666';
      };

      const overallRating = inspection.overallAssessment ? inspection.overallAssessment.rating : '미확인';
      const ratingColor = getRatingColor(overallRating);

      // 사진 목록 생성
      const photoUrls = DataLoader.getPhotoUrls(inspection);
      const photoGridHTML = photoUrls.length > 0 ? `
        <div class="photo-grid">
          ${photoUrls.slice(0, 6).map((url, index) => `
            <img src="${url}"
                 alt="점검 사진 ${index + 1}"
                 style="width: 100px; height: 100px; object-fit: cover; cursor: pointer; border-radius: 4px;"
                 onerror="this.style.display='none';">
          `).join('')}
        </div>
      ` : '<p style="color: #999;">사진이 없습니다.</p>';

      // 모달 HTML 생성
      const modal = document.createElement('div');
      modal.className = 'inspection-modal';
      modal.innerHTML = `
        <div class="modal-content">
          <button class="close-btn" onclick="this.closest('.inspection-modal').remove()">&times;</button>
          <h3 style="margin-top: 0; color: #333;">${inspection.targetName} 점검 상세</h3>
          <div class="modal-body">
            <p style="margin: 8px 0;"><strong>점검 유형:</strong> ${inspection.targetType}</p>
            <p style="margin: 8px 0;"><strong>점검 일자:</strong> ${inspection.inspectionDate}</p>
            <p style="margin: 8px 0;">
              <strong>종합 판정:</strong>
              <span style="color: ${ratingColor}; font-weight: 700; font-size: 16px;">${overallRating}</span>
            </p>
            <div style="margin-top: 16px;">
              <strong>사진 기록:</strong>
              <div style="margin-top: 8px;">
                ${photoGridHTML}
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button onclick="window.location.href='inspection-confirm.html?id=${inspection.id}'"
                    style="width: 100%; padding: 12px; background: #0052CC; color: white; border: none;
                           border-radius: 8px; cursor: pointer; font-size: 16px;">
              전체 보고서 보기 →
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // 모달 클릭 시 닫기 (배경 클릭)
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    // 점검 이력 팝업 표시
    function showInspectionPopup(x, y, point) {
      const popup = document.getElementById('inspectionPopup');
      popup.style.left = x + 'px';
      popup.style.top = y + 'px';
      popup.classList.add('active');
      popup.dataset.pointId = point.id;
    }

    // 점검 이력 마커 제거
    function clearInspectionMarkers() {
      GISRenderer.clearMarkers();
      document.getElementById('inspectionPopup').classList.remove('active');
    }

    // 재해 이력 표시
    function showDisasterHistory() {
      hideAllOverlays();
      setActiveMenu(2);
      currentMode = 'disaster';
      document.getElementById('disasterOverlay').classList.add('active');

      // 전체 재해 이력 표시
      renderDisasterHistory(allDisasterHistory);
    }

    // 재해 이력 필터 적용
    function applyDisasterFilters() {
      const elementFilter = document.getElementById('disasterElementFilter').value;
      const typeFilter = document.getElementById('disasterTypeFilter').value;
      const yearFilter = document.getElementById('disasterYearFilter').value;

      console.log('재해 이력 필터:', { elementFilter, typeFilter, yearFilter });

      let filtered = allDisasterHistory;

      // elementType 필터
      if (elementFilter !== 'all') {
        filtered = filtered.filter(item => item.elementType === elementFilter);
      }

      // type 필터 (호우, 강풍, 태풍)
      if (typeFilter !== 'all') {
        filtered = filtered.filter(item => item.type && item.type.includes(typeFilter));
      }

      // year 필터
      if (yearFilter !== 'all') {
        const year = parseInt(yearFilter);
        filtered = filtered.filter(item => item.year === year);
      }

      console.log(`재해 이력 필터링 결과: ${filtered.length}개 항목`);
      renderDisasterHistory(filtered);
    }

    // 재해 이력 렌더링 함수
    function renderDisasterHistory(disasters) {
      clearPolygons();

      disasters.forEach(disaster => {
        // 재해 위치에 작은 원형 마커 생성
        const circle = new google.maps.Circle({
          strokeColor: disaster.color || '#FF5252',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: disaster.color || '#FF5252',
          fillOpacity: 0.35,
          map: map,
          center: disaster.coordinates,
          radius: 15, // 15미터 반경
          clickable: true
        });

        // 클릭 이벤트: 재해 정보 표시
        circle.addListener('click', () => {
          showDisasterInfo(disaster);
        });

        polygons.push(circle);
      });
    }

    // 재해 정보 표시 함수
    function showDisasterInfo(disaster) {
      const infoContent = `
        <div style="padding: 10px; max-width: 250px;">
          <h4 style="margin: 0 0 8px 0; color: #E53935;">재해 이력</h4>
          <p style="margin: 4px 0;"><strong>연도:</strong> ${disaster.year}년</p>
          <p style="margin: 4px 0;"><strong>위치:</strong> ${disaster.location}</p>
          <p style="margin: 4px 0;"><strong>종류:</strong> ${disaster.type}</p>
          <p style="margin: 4px 0;"><strong>대상:</strong> ${disaster.target}</p>
          <p style="margin: 4px 0;"><strong>피해:</strong> ${disaster.damage}</p>
        </div>
      `;

      const infoWindow = new google.maps.InfoWindow({
        content: infoContent,
        position: disaster.coordinates
      });

      infoWindow.open(map);
    }

    // 수리 이력 표시
    function showRepairHistory() {
      hideAllOverlays();
      setActiveMenu(3);
      currentMode = 'repair';
      document.getElementById('repairOverlay').classList.add('active');
      document.querySelector('.repair-submenu-container').classList.add('active');

      // 전체 수리 이력 표시 (필터: '전통조경요소')
      renderRepairHistory(allRepairHistory);
    }

    // 수리 이력 렌더링 함수
    function renderRepairHistory(repairs) {
      clearPolygons();

      repairs.forEach(repair => {
        // 수리 위치에 작은 원형 마커 생성
        const circle = new google.maps.Circle({
          strokeColor: repair.color || '#4CAF50',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: repair.color || '#4CAF50',
          fillOpacity: 0.35,
          map: map,
          center: repair.coordinates,
          radius: 15, // 15미터 반경
          clickable: true
        });

        // 클릭 이벤트: 수리 정보 표시
        circle.addListener('click', () => {
          showRepairInfo(repair);
        });

        polygons.push(circle);
      });
    }

    // 수리 정보 표시 함수
    function showRepairInfo(repair) {
      const infoContent = `
        <div style="padding: 10px; max-width: 250px;">
          <h4 style="margin: 0 0 8px 0; color: #4CAF50;">수리 이력</h4>
          <p style="margin: 4px 0;"><strong>연도:</strong> ${repair.year}년</p>
          <p style="margin: 4px 0;"><strong>위치:</strong> ${repair.location}</p>
          <p style="margin: 4px 0;"><strong>대상:</strong> ${repair.target}</p>
          <p style="margin: 4px 0;"><strong>내용:</strong> ${repair.workDescription}</p>
          ${repair.cost ? `<p style="margin: 4px 0;"><strong>비용:</strong> ${repair.cost}</p>` : ''}
        </div>
      `;

      const infoWindow = new google.maps.InfoWindow({
        content: infoContent,
        position: repair.coordinates
      });

      infoWindow.open(map);
    }

    // 수리 이력 필터 선택
    function selectRepairFilter(filterType) {
      // 모든 서브메뉴 아이템 비활성화
      document.querySelectorAll('#repairSubmenu .submenu-item').forEach(item => {
        item.classList.remove('active');
      });
      // 클릭한 아이템 활성화
      event.currentTarget.classList.add('active');

      console.log('수리 이력 선택된 필터:', filterType);

      // DataLoader의 필터링 함수 사용 (elementType 기반)
      const filtered = DataLoader.filterHistory(allRepairHistory, filterType);
      console.log(`수리 이력 필터링 결과: ${filtered.length}개 항목`);

      // 필터링된 데이터로 지도 업데이트
      renderRepairHistory(filtered);
    }

    // 폴리곤 제거
    function clearPolygons() {
      polygons.forEach(polygon => polygon.setMap(null));
      polygons = [];
    }

    // 모달 닫기
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      setActiveMenu(-1);
    }

    // 보고서 표시
    function showReport() {
      alert('안전 점검 보고서를 표시합니다.');
      document.getElementById('inspectionPopup').classList.remove('active');
    }

    // 사진 표시
    function showPhotos() {
      alert('점검 사진을 표시합니다.');
      document.getElementById('inspectionPopup').classList.remove('active');
    }

    // 메타포트 열기
    function openMetafort() {
      alert('메타포트 링크로 이동합니다.');
      document.getElementById('inspectionPopup').classList.remove('active');
    }

    // 클릭 시 팝업 닫기
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.inspection-popup') && !e.target.closest('.gm-style')) {
        document.getElementById('inspectionPopup').classList.remove('active');
      }
    });

    // 모달 외부 클릭 시 닫기
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
          setActiveMenu(-1);
        }
      });
    });
  </script>

  <!-- Google Maps API -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA38pzCsLGAwnkQMIoKiWPqTw_a1XJE5W0&callback=initMap">
  </script>
</body>
</html>
